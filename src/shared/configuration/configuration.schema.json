{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://obin.ai/schemas/configuration.schema.json",
  "title": "Spreadsheet Configuration",
  "type": "object",
  "required": ["version", "inputs", "outputs", "metadata"],
  "properties": {
    "version": {
      "type": "string",
      "pattern": "^v\\d+$",
      "description": "Semantic tag for the configuration snapshot (e.g., v5)."
    },
    "schemaVersion": {
      "type": "string",
      "minLength": 1,
      "description": "Optional schema version tag; must match metadata.schemaVersion when present."
    },
    "inputs": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/definitions/InputMapping" }
    },
    "outputs": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/definitions/OutputMapping" }
    },
    "metadata": { "$ref": "#/definitions/ConfigurationMetadata" }
  },
  "additionalProperties": false,
  "definitions": {
    "InputMapping": {
      "type": "object",
      "required": ["type", "sheetName", "cellId", "label", "dataType"],
      "properties": {
        "type": { "const": "input" },
        "sheetName": { "type": "string", "minLength": 1 },
        "cellId": {
          "type": "string",
          "pattern": "^[A-Z]+[0-9]+$"
        },
        "label": { "type": "string", "minLength": 1 },
        "dataType": {
          "type": "string",
          "enum": ["number", "text", "percentage", "currency", "date"]
        },
        "constraints": {
          "oneOf": [
            { "type": "null" },
            { "$ref": "#/definitions/ConstraintDiscrete" },
            { "$ref": "#/definitions/ConstraintRange" }
          ],
          "description": "When present, must align with dataType rules; range allowed only for number, percentage, currency, or date."
        }
      },
      "additionalProperties": false
    },
    "OutputMapping": {
      "type": "object",
      "required": ["type", "sheetName", "cellId", "label"],
      "properties": {
        "type": { "const": "output" },
        "sheetName": { "type": "string", "minLength": 1 },
        "cellId": {
          "type": "string",
          "pattern": "^[A-Z]+[0-9]+$"
        },
        "label": { "type": "string", "minLength": 1 }
      },
      "not": {
        "anyOf": [{ "required": ["dataType"] }, { "required": ["constraints"] }]
      },
      "additionalProperties": false
    },
    "ConstraintDiscrete": {
      "type": "object",
      "required": ["type", "values"],
      "properties": {
        "type": { "const": "discrete" },
        "values": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string",
            "minLength": 1
          }
        }
      },
      "additionalProperties": false
    },
    "ConstraintRange": {
      "type": "object",
      "required": ["type", "min", "max"],
      "properties": {
        "type": { "const": "range" },
        "min": { "type": ["number", "null"] },
        "max": { "type": ["number", "null"] }
      },
      "description": "Both min and max must be numbers when provided; enforce min <= max in business logic.",
      "additionalProperties": false
    },
    "ConfigurationMetadata": {
      "type": "object",
      "required": ["createdAt", "version"],
      "properties": {
        "createdAt": {
          "type": "string",
          "format": "date-time"
        },
        "updatedAt": {
          "oneOf": [
            { "type": "string", "format": "date-time" },
            { "type": "null" }
          ]
        },
        "version": {
          "type": "string",
          "pattern": "^v\\d+$"
        },
        "schemaVersion": {
          "type": "string",
          "minLength": 1
        },
        "source": {
          "type": "string"
        }
      },
      "additionalProperties": false
    }
  }
}
