# Implementation Plan: Excel-to-Google Sheet Conversion Backend (Production)

**Branch**: `001-sheet-conversion-backend` | **Date**: 2025-10-26 | **Spec**: [spec.md](../spec.md)
**Input**: Feature specification from `/specs/001-sheet-conversion-backend/spec.md`

**Note**: This template is filled in by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

Deliver a production Express.js + TypeScript backend service that exposes two orthogonal APIs: `POST /conversion/upload` converts an uploaded Excel workbook into a governed Google Sheet and returns the sheet ID/link, while `POST /mapping/execute` ingests an existing sheet ID plus the admin-portal mapping JSON to compute output parameters. The service will leverage Google Drive and Google Sheets APIs with a service account, persist conversion/execution audit records in PostgreSQL, and apply shared configuration logic so each API can evolve independently without shared state coupling.

## Technical Context

- **Language/Version**: TypeScript 5.9 targeting Node.js 20 LTS
- **Primary Dependencies**: Express 5, `googleapis` (Drive v3 + Sheets v4 clients), Multer for streaming uploads, Zod for request validation, Prisma ORM for PostgreSQL access, Pino for structured logging
- **Storage**: PostgreSQL 15 (audit log tables for conversions and executions)
- **Testing**: Manual verification only (constitution rule 5)
- **Target Platform**: Cloudflare Workers with Node.js compatibility enabled, deployed via Wrangler
- **Project Type**: Production backend service
- **Performance Goals**: 95% of conversions <60s; 99% of mapping executions <5s (per success criteria)
- **Constraints**: Enforce authenticated internal access, cap uploads at 10 MiB, honor Google API quota/backoff guidance, emit correlation IDs + audit logging
- **Scale/Scope**: Anticipated ~1k conversion/execution requests per day with bursts of concurrent automation clients

## Constitution Check

_Gate: must pass before Phase 0 research and re-check after Phase 1 design._

- **Rule 1 (Prototype speed over quality)**: Production scope with deliberate quality controls → _Compliant_.
- **Rule 2 (Hardcode data when prototyping)**: Dynamic integrations required; rule not applicable → _Compliant_.
- **Rule 4 (Optimize artifacts for LLMs)**: Documentation structured for machine parsing → _Compliant_.
- **Rule 5 (No testing unless asked)**: Rely on manual verification only → _Compliant_.
- **Rule 6 (Source boundaries)**: Code isolated under `src/production/backend` and uses `src/shared` for shared logic → _Compliant_.
- **Rule 8 (.env secrets)**: Credentials sourced from `.env`/secret manager → _Compliant_.
- **Rule 10 (Deploy via GitHub Pages / Cloudflare Workers)**: Target Cloudflare Workers with Node compatibility → _Compliant_.

**Gate Status:** PASS

**Post-Design Gate Review (2025-10-26):** No new violations introduced during Phase 1 design artifacts; deployment and source layout remain within constitutional bounds.

## Project Structure

### Documentation (this feature)

```text
specs/001-sheet-conversion-backend/
├── plan.md
├── research.md
├── data-model.md
├── quickstart.md
├── contracts/
└── tasks.md  # generated by /speckit.tasks
```

### Source Code (repository root)

```text
src/
└── production/
    └── backend/
        └── sheet-conversion/
            ├── src/
            │   ├── api/
            │   │   ├── conversion/
            │   │   └── mapping/
            │   ├── services/
            │   │   ├── google-drive/
            │   │   └── google-sheets/
            │   ├── domains/
            │   │   ├── conversion/
            │   │   └── mapping/
            │   ├── repositories/
            │   │   └── audit/
            │   ├── middleware/
            │   └── config/
            ├── prisma/
            │   └── schema.prisma
            ├── package.json
            ├── tsconfig.json
            ├── wrangler.toml
            └── README.md
```

**Structure Decision**: Introduce a dedicated production backend package under `src/production/backend/sheet-conversion` where conversion and mapping APIs remain in separate domain folders that only share low-level Google client utilities. Prisma schema + config live alongside the service, while shared mapping transforms continue to be consumed from `src/shared/configuration`.

## Complexity Tracking

No constitutional violations identified; tracking table not required.
